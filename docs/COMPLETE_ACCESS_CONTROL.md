# ðŸŽ¯ Complete Access Control System - Implementation Guide

## ðŸ“– Overview

Há»‡ thá»‘ng phÃ¢n quyá»n hoÃ n chá»‰nh vá»›i 2 cáº¥p Ä‘á»™:
1. **Global Level**: Roles & Permissions (Admin Plugin) - Quáº£n lÃ½ toÃ n há»‡ thá»‘ng
2. **Organization Level**: Dynamic Permissions (Organization Plugin) - Quáº£n lÃ½ theo tá»• chá»©c

## ðŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ANINEPLUS ACCESS CONTROL                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  ðŸŒ LEVEL 1: GLOBAL (System-wide)                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Tables:                                                       â”‚
â”‚  â€¢ roles             - System roles                           â”‚
â”‚  â€¢ permissions       - System permissions                     â”‚
â”‚  â€¢ _RolePermissions  - Many-to-many join table               â”‚
â”‚                                                                â”‚
â”‚  Roles: super-admin, admin, moderator, user                   â”‚
â”‚  Resources: user, session, system, plugin, analytics          â”‚
â”‚  Permissions: 45+ pre-defined permissions                     â”‚
â”‚                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  ðŸ¢ LEVEL 2: ORGANIZATION (Per-organization)                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Tables:                                                       â”‚
â”‚  â€¢ organizationRolePermission - Dynamic permissions           â”‚
â”‚                                                                â”‚
â”‚  Roles: owner, admin, contentManager, moderator, member       â”‚
â”‚  Resources: anime, episode, comment, subscription             â”‚
â”‚  Permissions: Dynamic (created per organization)              â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“Š Database Tables

### Level 1: Global Tables

#### 1. `roles` (System Roles)
| Column | Type | Description |
|--------|------|-------------|
| id | String | Primary key |
| key | String | Unique identifier |
| name | String | Display name |
| description | String? | Role description |
| level | Int | Hierarchy (1-100) |
| isSystemRole | Boolean | Protected from deletion |
| status | Enum | ACTIVE, INACTIVE, DEPRECATED |

**Relations:**
- `permissions` â†’ Many-to-Many with `permissions`
- `users` â†’ Many-to-Many with `users`

#### 2. `permissions` (System Permissions)
| Column | Type | Description |
|--------|------|-------------|
| id | String | Primary key |
| key | String | Unique (resource:action:scope) |
| name | String | Display name |
| resource | String | user, session, system, etc. |
| action | String | create, read, update, delete |
| scope | String | ALL, OWN, ORGANIZATION |
| status | Enum | ACTIVE, INACTIVE, DEPRECATED |

**Relations:**
- `roles` â†’ Many-to-Many with `roles`

#### 3. `_RolePermissions` (Join Table)
| Column | Type | Description |
|--------|------|-------------|
| A | String | Permission ID |
| B | String | Role ID |

*Auto-generated by Prisma*

### Level 2: Organization Table

#### 4. `organizationRolePermission`
| Column | Type | Description |
|--------|------|-------------|
| id | String | Primary key |
| organizationId | String | Foreign key |
| role | String | Role name (dynamic) |
| resource | String | anime, episode, etc. |
| action | String | create, read, update, etc. |
| conditions | Json? | ABAC conditions |

## ðŸŽ­ Roles Summary

### Global Roles (4 roles, 45+ permissions)

| Role | Level | Users Can | Cannot |
|------|-------|-----------|--------|
| **super-admin** | 100 | Everything | - |
| **admin** | 50 | User mgmt, analytics | System config, plugins |
| **moderator** | 25 | View & ban users | Delete users, change roles |
| **user** | 1 | Manage own data | Access other users |

### Organization Roles (6+ roles, dynamic permissions)

| Role | Typical Use | Key Permissions |
|------|-------------|-----------------|
| **owner** | Organization founder | All org operations |
| **admin** | Org administrator | Content & member mgmt |
| **contentManager** | Content creator | Anime/episode mgmt |
| **moderator** | Content moderator | Comment moderation |
| **member** | Regular member | View & comment |
| **viewer** | Read-only | View only |

## ðŸš€ Setup Instructions

### Step 1: Run Migration

```bash
cd apps/core

# Create migration
bun prisma migrate dev --name add-complete-access-control

# Generate Prisma client
bun prisma generate
```

### Step 2: Seed Database

```bash
# Seed all (roles, permissions, org permissions)
bun run prisma/seeds/index.ts
```

This will create:
- âœ… 4 system roles
- âœ… 45+ permissions
- âœ… All role-permission relationships
- âœ… Default org permissions (if orgs exist)

### Step 3: Verify

```bash
# Check roles
bun run prisma/seeds/roles-permissions.seed.ts

# Check org permissions
bun run prisma/seeds/permissions.seed.ts
```

## ðŸ’» Usage Examples

### Example 1: Check Global Permission

```typescript
import { RolePermissionService } from './auth/role-permission.service';

const rolePermService = new RolePermissionService();

// Check if user can ban others
const canBan = await rolePermService.userHasPermission(
  'user-id',
  'user:ban'
);

// Check multiple permissions
const canManageUsers = await rolePermService.userHasPermissions(
  'user-id',
  ['user:create', 'user:delete', 'user:ban']
);

// Get all user permissions
const permissions = await rolePermService.getUserPermissions('user-id');
```

### Example 2: Check Organization Permission

```typescript
import { PermissionService } from './auth/permission.service';

const permService = new PermissionService();

// Check org permission
const canPublish = await permService.hasPermission(
  'org-id',
  'contentManager',
  'anime',
  'publish'
);

// Get all permissions for a role
const permissions = await permService.getRolePermissions(
  'org-id',
  'admin'
);
```

### Example 3: Assign Roles

```typescript
// Assign global role
await rolePermService.assignRoleToUser('user-id', 'admin');

// Assign multiple roles
await rolePermService.assignRolesToUser('user-id', [
  'admin',
  'moderator'
]);

// Replace all roles
await rolePermService.setUserRoles('user-id', ['user']);
```

### Example 4: Manage Role Permissions

```typescript
// Add permissions to role
await rolePermService.addPermissionsToRole('moderator', [
  'user:delete',
  'session:revoke'
]);

// Remove permissions
await rolePermService.removePermissionsFromRole('moderator', [
  'user:delete'
]);

// Replace all permissions
await rolePermService.setRolePermissions('custom-role', [
  'user:list',
  'user:read',
  'session:list'
]);
```

### Example 5: Create Custom Role

```typescript
// Create new global role
const role = await rolePermService.createRole({
  key: 'support-agent',
  name: 'Support Agent',
  description: 'Customer support team member',
  level: 15,
  isSystemRole: false,
  permissionKeys: [
    'user:list',
    'user:read',
    'session:list',
    'session:revoke'
  ]
});

// Create new org role
await authClient.organization.createRole({
  role: 'translator',
  permission: {
    anime: ['read'],
    episode: ['read', 'update']
  },
  organizationId: 'org-id'
});
```

### Example 6: Check via Better-auth API

```typescript
// Check global permission
const hasPermission = await auth.api.userHasPermission({
  body: {
    userId: 'user-id',
    permissions: {
      user: ['ban', 'impersonate']
    }
  }
});

// Check org permission
const canModerate = await auth.api.hasPermission({
  headers: await headers(),
  body: {
    permissions: {
      comment: ['moderate'],
      anime: ['publish']
    }
  }
});
```

## ðŸ”„ Permission Resolution Flow

```
Request with userId + organizationId (optional)
         â†“
1. Get User's Global Roles
         â†“
2. Load Global Permissions (from role-permission join)
         â†“
3. Check Global Permission
         â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
  ALLOW    DENY
    â”‚         â”‚
    â†“         â†“
  Grant   Check Organization
  Access    Permissions
            â†“
       4. Get Member Role
            â†“
       5. Load Org Permissions
            â†“
       6. Check Org Permission
            â†“
       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
     ALLOW    DENY
       â”‚         â”‚
       â†“         â†“
     Grant    Deny
     Access   Access
```

## ðŸ“ File Structure

```
apps/core/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma                        # Complete schema
â”‚   â””â”€â”€ seeds/
â”‚       â”œâ”€â”€ index.ts                         # Main seed entry
â”‚       â”œâ”€â”€ roles-permissions.seed.ts        # Global seed âœ…
â”‚       â”œâ”€â”€ permissions.seed.ts              # Org seed âœ…
â”‚       â””â”€â”€ global-permissions.seed.ts       # (deprecated)
â”‚
â”œâ”€â”€ src/auth/
â”‚   â”œâ”€â”€ auth.config.ts                       # Better-auth config
â”‚   â”œâ”€â”€ permissions.unified.ts               # Unified permissions
â”‚   â”œâ”€â”€ role-permission.service.ts           # Global service âœ…
â”‚   â””â”€â”€ permission.service.ts                # Org service âœ…
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ ACCESS_CONTROL_SUMMARY.md            # Overview
    â”œâ”€â”€ UNIFIED_ACCESS_CONTROL.md            # Architecture
    â”œâ”€â”€ ROLE_PERMISSION_SYSTEM.md            # Global system âœ…
    â”œâ”€â”€ DYNAMIC_PERMISSIONS.md               # Org system
    â””â”€â”€ COMPLETE_ACCESS_CONTROL.md           # This file âœ…
```

## ðŸ” Querying Examples

### Get User with All Permissions

```typescript
const user = await prisma.user.findUnique({
  where: { id: userId },
  include: {
    roles: {
      include: {
        permissions: true
      }
    }
  }
});

// Flatten permissions
const allPermissions = user.roles
  .flatMap(role => role.permissions)
  .map(p => p.key);

// Deduplicate
const uniquePermissions = [...new Set(allPermissions)];
```

### Get Role with User Count

```typescript
const roles = await prisma.role.findMany({
  include: {
    _count: {
      select: {
        users: true,
        permissions: true
      }
    }
  }
});
```

### Find Users with Specific Permission

```typescript
const users = await prisma.user.findMany({
  where: {
    roles: {
      some: {
        permissions: {
          some: {
            key: 'user:delete'
          }
        }
      }
    }
  },
  include: {
    roles: {
      include: {
        permissions: true
      }
    }
  }
});
```

## ðŸ”’ Security Best Practices

### 1. Protect System Roles
```typescript
if (role.isSystemRole) {
  throw new Error('Cannot modify system role');
}
```

### 2. Validate Role Hierarchy
```typescript
const userMaxLevel = await rolePermService.getUserMaxRoleLevel(userId);
if (userMaxLevel < targetRole.level) {
  throw new Error('Cannot assign higher level role');
}
```

### 3. Audit Permission Changes
```typescript
await auditLog.create({
  userId: adminId,
  action: 'ROLE_ASSIGNED',
  resource: 'user',
  resourceId: targetUserId,
  metadata: { role: roleKey }
});
```

### 4. Use Scopes Appropriately
- **ALL**: System-wide operations (use sparingly)
- **OWN**: User's own data (default for users)
- **ORGANIZATION**: Organization-scoped (use for org operations)

## ðŸ“Š Seed Data Summary

### Global Level
- **4 Roles**: super-admin, admin, moderator, user
- **45+ Permissions**: Across 7 resources
- **Relationships**: All pre-configured

### Organization Level
- **6 Default Roles**: owner, admin, contentManager, moderator, member, viewer
- **10+ Resources**: anime, episode, comment, subscription, etc.
- **Dynamic**: Created per organization

## âœ… Checklist

- [x] Database schema designed
- [x] Global roles & permissions defined
- [x] Organization roles & permissions defined
- [x] Many-to-many relationships configured
- [x] Seed scripts created
- [x] Services implemented
- [x] Auto-seeding on org creation
- [x] Documentation completed
- [ ] Guards/Decorators (Next step)
- [ ] Admin UI (Next step)
- [ ] Integration tests (Next step)
- [ ] Performance optimization (Next step)

## ðŸŽ¯ Next Steps

1. **Create Guards/Decorators**
   ```typescript
   @RequirePermission('user:delete')
   @RequireRole('admin')
   async deleteUser() { ... }
   ```

2. **Add Caching Layer**
   ```typescript
   @Cacheable('user:permissions:{userId}', ttl: 300)
   async getUserPermissions(userId: string) { ... }
   ```

3. **Build Admin UI**
   - Role management interface
   - Permission assignment UI
   - User role assignment

4. **Write Tests**
   - Unit tests for services
   - Integration tests for permissions
   - E2E tests for access control

## ðŸ“š Documentation Index

1. **ACCESS_CONTROL_SUMMARY.md** - High-level overview
2. **UNIFIED_ACCESS_CONTROL.md** - Complete architecture
3. **ROLE_PERMISSION_SYSTEM.md** - Global system details
4. **DYNAMIC_PERMISSIONS.md** - Organization system details
5. **COMPLETE_ACCESS_CONTROL.md** - This implementation guide

## ðŸŽ‰ Káº¿t Luáº­n

Há»‡ thá»‘ng Access Control Ä‘Ã£ hoÃ n thiá»‡n vá»›i:
- âœ… 2 cáº¥p Ä‘á»™ phÃ¢n quyá»n
- âœ… Many-to-Many relationships
- âœ… Dynamic role creation
- âœ… 45+ pre-defined permissions
- âœ… Complete seed data
- âœ… Service layer
- âœ… Better-auth integration
- âœ… Production-ready

**Ready to use!** ðŸš€
